(function(e){"use strict";var t,n=[],r=[],i,s,o,u,a,f=!1,l=[],c=[],h=new google.maps.LatLng,p=[],d,u,v=new google.maps.Circle,m=new google.maps.Rectangle,g=[],y=[],b=new RegExp("[,]"),w=new google.maps.Geocoder,E,S=new google.maps.Marker,x=google.maps.geometry.spherical,T=document.getElementById("form-city"),N=document.getElementById("form-range"),C=e("#form-city"),k=e("#form-range"),L={types:["(cities)"],componentRestrictions:{country:"be"},setTypes:["geocode"]},A,O=!1,M=e('.mapItem input[type="submit"]'),_,D=e(".loading"),P=e("#filter"),H=e(".mapItem");e(function(){e("#form-range").val();e("#form-range").on("change",function(){e(this).val()>999?e(".label-range").html("Distance: "+e(this).val()/1e3+"km"):e(".label-range").html("Distance: "+e(this).val()+"m")})});var B=function(){W();z();A=new google.maps.places.Autocomplete(T,L);e("#rapide input").on("click",z);google.maps.event.addListener(A,"place_changed",function(){O=!0;var n=A.getPlace();if(!n.geometry)return;var r=n.geometry.location;t.panTo(r);t.setZoom(17);S.setPosition(r);S.setMap(t);var i=N.value;e.isNumeric(i)?u=i:u=0;var s=r;f?Q(u):it(s,u,"latlng",function(e,t){if(e){U(M,0);k.next().hasClass("tuto")||k.next().hasClass("messageTuto")||k.after('<span class="range messageTuto">Vous pouvez régler la distance</span>')}else U(M,0)})});tt();D.fadeOut();H.css("display","block")},j=function(){P.click(function(){var t=N.value;e.isNumeric(t)?u=t:u=0;var n=T.value;f?Q(u):it(n,u,"geocoder",function(e,t){if(e){U(M,0);F(k,"messageTuto")}else U(M,0)});return!1});C.change(function(){var t=N.value;e.isNumeric(t)?u=t:u=0;var n=T.value;f=!1;F(k,"messageTuto");I(C);f?Q(u):it(n,u,"geocoder",function(e,t){if(e){U(M,0);k.next().hasClass("tuto")||k.next().hasClass("messageTuto")||k.after('<span class="range messageTuto">Vous pouvez régler la distance</span>')}else U(M,0)})});k.change(function(){var t=Math.round(N.value);e.isNumeric(t)?u=t:u=0;var n=T.value;q(n==="",e(".localite.messageError"),C,"localite",e(".mainType"),"Selectionnez une location",C);f=!1;f?Q(u):it(n,u,"geocoder",function(e,t){if(e){U(M,0);k.next().hasClass("messageTuto")&&k.next().remove();F(k,"messageTuto")}else U(M,0)})})},F=function(e,t){e.next().hasClass(t)&&e.next().remove()},I=function(t){if(t.hasClass("form-error")){t.removeClass("form-error");t.next().remove()}t.find(".messageError").length<=0&&e(".errors").removeClass("none").addClass("none")},q=function(e,t,n,r,i,s,o){if(e){t.length<=0&&n.after('<span class="'+r+' messageError">Entrez une localitée en premier</span>').html(s);n.addClass("form-error");o&&o.focus()}},R=function(e){if(e.length>0&&e.hasClass("none")){e.removeClass("none");e.find("span").length<=0&&e.append("<span>erreur(s) détectée(s)</span>")}},U=function(t,n){n===1?t.prop("disabled",!0).val("Recherche..."):n===0&&t.delay(600).queue(function(t){e(this).prop("disabled",!1).val("Filtrer");t()})},z=function(){e("label.map1").text("Ecole ciblée");e("input#map").attr("placeholder","Ecole");if(e("#rapide input:checked").val()==="aucun")Z();else{et();e("label.map1").text("Indiquez l'adresse ou clickez sur une école");e("input#map").attr("placeholder","Ville, école")}j()},W=function(){e.ajax({dataType:"json",url:"getKots",type:"get",success:function(e){o=e.data;V(o)}})},X=function(){e.ajax({dataType:"json",url:"dataEcole",success:function(e){a=e.data;$(a)}})},V=function(e){var t=new google.maps.MarkerImage("http://www.google.com/intl/en_us/mapfiles/ms/micons/red-dot.png");for(var n=0;n<=e.length-1;n++){var r=e[n].lat,i=e[n].lng,s=[r,i];g.push(s);J(Number(g[n][0]),Number(g[n][1]),e[n].adresse,t)}},$=function(e){var t=new google.maps.MarkerImage("http://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png");for(var n=0;n<=e.length-1;n++){var r=e[n].lat,i=e[n].lng,s=[r,i];y.push(s);K(Number(y[n][0]),Number(y[n][1]),e[n].nom,t)}},J=function(e,r,s,o){var u=new google.maps.LatLng(e,r);i=new google.maps.Marker({position:u,map:t,animation:google.maps.Animation.DROP,title:s,icon:o});n.push(i)},K=function(n,o,u,l){var d=new google.maps.LatLng(n,o);s=new google.maps.Marker({position:d,map:t,animation:google.maps.Animation.DROP,title:u,icon:l});r.push(i);google.maps.event.addListener(s,"click",function(n){f=!0;console.log(f);p=[];t.setZoom(12);t.panTo(s.getPosition());for(var r=0;r<=a.length-1;r++){p={latlng:new google.maps.LatLng(a[r].lat,a[r].lng),nom:a[r].nom};c.push(p)}for(var r=0;r<=c.length-1;r++)if(n.latLng.lat()===c[r].latlng.lat()&&n.latLng.lng()===c[r].latlng.lng()){e("#map").attr("value",c[r].nom);h=new google.maps.LatLng(c[r].latlng.lat(),c[r].latlng.lng())}})},Q=function(e){nt("ecole",h,u)},G=function(e,n,r){return{strokeColor:r,strokeOpacity:.8,strokeWeight:2,fillColor:r,fillOpacity:.35,map:t,center:e,radius:n}},Y=function(r,i){l=[];var s=G(r,i);v.setOptions(s);v.bindTo("center",S,"position");var u=v.getBounds();for(var a=0;a<o.length;a++)if(!u.contains(new google.maps.LatLng(o[a].lat,o[a].lng)))n[a].setMap(null);else{l.push(o[a]);n[a].setMap(t);t.fitBounds(u);e("#listKot").attr("value",JSON.stringify(l))}},Z=function(){e("#gmap").css({display:"none"});e(".mapInfo").css({height:"auto",marginLeft:0,"float":"none"})},et=function(){e("#gmap").css({display:"block"});e(".mapInfo").css({height:"auto",marginLeft:0,"float":"left"})},tt=function(){var e=[{featureType:"administrative.country",elementType:"geometry.stroke",stylers:[{color:"#00006f"},{lightness:-5},{visibility:"on"},{weight:3},{hue:"#ff0091"}]},{featureType:"all",elementType:"all",stylers:[{invert_lightness:!0},{saturation:0},{lightness:25},{gamma:.6},{hue:"#435158"}]}],n={disableDefaultUI:!0,scrollwheel:!1,zoom:7,minZoom:7,maxZoom:17,mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(50.5,4.6),styles:e};t=new google.maps.Map(document.getElementById("gmap"),n)},nt=function(e,n,r){v&&v.setMap(null);l=Number(r);var i=n,s=x.computeOffset(i,l,0),o=x.computeOffset(i,l,-90),u=x.computeOffset(i,l,180),a=x.computeOffset(i,l,90);if(e==="ville"){S.setPosition(i);S.setMap(t);var f="#FF0000"}else e==="ecole";var f="#0000FF",l=google.maps.geometry.spherical.computeDistanceBetween(i,s),c=G(n,l,f);v.setOptions(c);var h=new Array(s,o,u,a),p=new google.maps.LatLngBounds;for(var d=0,m=h.length;d<m;d++)p.extend(h[d]);t.fitBounds(p);Y(n,l)},rt=function(e,t,n){if(n>=t)return;var r=google.maps.event.addListener(e,"zoom_changed",function(i){google.maps.event.removeListener(r);rt(e,t,n+1)});setTimeout(function(){e.setZoom(n)},80)},it=function(n,r,i,s){var o=Number(r);if(i==="geocoder"){U(M,1);var u={disableDefaultUI:!0,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,center:w.geocode({address:n,region:"BE"},function(n,i){if(i===google.maps.GeocoderStatus.OK){var u=n[0].geometry.location;t.setZoom(10);t.panTo(u);e("#coords").attr("value",u);var a=x.computeOffset(u,o,360);S.setPosition(u);S.setMap(t);google.maps.event.addListener(S,"click",function(){rt(t,20,t.getZoom());t.panTo(S.getPosition())});nt("ville",u,r);s(!0)}else i===google.maps.GeocoderStatus.ZERO_RESULTS?s(!1,"La google map n'a rien trouvé car aucune donnée n'a été entré"):i===google.maps.GeocoderStatus.INVALID_REQUEST&&s(!1,"La google map n'a rien trouvé car la requête est incorrect")})}}else if(i==="latlng"){U(M,1);t.setZoom(13);t.panTo(n);S.setPosition(n);S.setMap(t);google.maps.event.addListener(S,"click",function(){rt(t,20,t.getZoom());t.panTo(S.getPosition())});nt("ville",n,r);s(!0)}};google.maps.event.addDomListener(window,"load",B)}).call(this,jQuery);