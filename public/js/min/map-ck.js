(function(e){"use strict";var o,t,a,n,n,s,l=[],r=!1,i=[],c=new google.maps.LatLng,g=new google.maps.Circle,m=(new google.maps.Rectangle,[]),u=(new RegExp("[,]"),new google.maps.Geocoder),p=new google.maps.Marker,f=google.maps.geometry.spherical,d=document.getElementById("form-city"),v=document.getElementById("form-range"),h=e("#form-city"),y=e("#form-range"),T={types:["(cities)"],componentRestrictions:{country:"be"},setTypes:["geocode"]},w=!1,L=e('.mapItem input[type="submit"]'),b=e(".loading"),I=e("#filter"),k=e(".mapItem");e(function(){e("#form-range").val(),e("#form-range").on("change",function(){e(".label-range").html(e(this).val()>999?"Distance: "+e(this).val()/1e3+"km":"Distance: "+e(this).val()+"m")})});var M=function(){P(),N(),s=new google.maps.places.Autocomplete(d,T),e("#rapide input").on("click",N),google.maps.event.addListener(s,"place_changed",function(){w=!0;var t=s.getPlace();if(t.geometry){var a=t.geometry.location;o.panTo(a),o.setZoom(17),p.setPosition(a),p.setMap(o);var l=v.value;n=e.isNumeric(l)?l:0;var i=a;r?Z(n):V(i,n,"latlng",function(e){e?(D(L,0),y.next().hasClass("tuto")||y.next().hasClass("messageTuto")||y.after('<span class="range messageTuto">Vous pouvez régler la distance</span>')):D(L,0)})}}),F(),b.fadeOut(),k.css("display","block")},O=function(){I.click(function(){var o=v.value;n=e.isNumeric(o)?o:0;var t=d.value;return r?Z(n):V(t,n,"geocoder",function(e){e?(D(L,0),x(y,"messageTuto")):D(L,0)}),!1}),h.change(function(){var o=v.value;n=e.isNumeric(o)?o:0;var t=d.value;r=!1,x(y,"messageTuto"),E(h),r?Z(n):V(t,n,"geocoder",function(e){e?(D(L,0),y.next().hasClass("tuto")||y.next().hasClass("messageTuto")||y.after('<span class="range messageTuto">Vous pouvez régler la distance</span>')):D(L,0)})}),y.change(function(){var o=Math.round(v.value);n=e.isNumeric(o)?o:0;var t=d.value;C(""===t,e(".localite.messageError"),h,"localite",e(".mainType"),"Selectionnez une location",h),r=!1,r?Z(n):V(t,n,"geocoder",function(e){e?(D(L,0),y.next().hasClass("messageTuto")&&y.next().remove(),x(y,"messageTuto")):D(L,0)})})},x=function(e,o){e.next().hasClass(o)&&e.next().remove()},E=function(o){o.hasClass("form-error")&&(o.removeClass("form-error"),o.next().remove()),o.find(".messageError").length<=0&&e(".errors").removeClass("none").addClass("none")},C=function(e,o,t,a,n,s,l){e&&(o.length<=0&&t.after('<span class="'+a+' messageError">Entrez une localitée en premier</span>').html(s),t.addClass("form-error"),l&&l.focus())},D=function(o,t){1===t?o.prop("disabled",!0).val("Recherche..."):0===t&&o.delay(600).queue(function(o){e(this).prop("disabled",!1).val("Filtrer"),o()})},N=function(){e("label.map1").text("Ecole ciblée"),e("input#map").attr("placeholder","Ecole"),"aucun"===e("#rapide input:checked").val()?S():(_(),e("label.map1").text("Indiquez l'adresse ou clickez sur une école"),e("input#map").attr("placeholder","Ville, école")),O()},P=function(){e.ajax({dataType:"json",url:"getKots",type:"get",success:function(e){a=e.data,R(a)}})},R=function(e){for(var o=new google.maps.MarkerImage("http://www.google.com/intl/en_us/mapfiles/ms/micons/red-dot.png"),t=0;t<=e.length-1;t++){var a=e[t].lat,n=e[t].lng,s=[a,n];m.push(s),B(Number(m[t][0]),Number(m[t][1]),e[t].adresse,o)}},B=function(e,a,n,s){var r=new google.maps.LatLng(e,a);t=new google.maps.Marker({position:r,map:o,animation:google.maps.Animation.DROP,title:n,icon:s}),l.push(t)},Z=function(){G("ecole",c,n)},z=function(e,t,a){return{strokeColor:a,strokeOpacity:.8,strokeWeight:2,fillColor:a,fillOpacity:.35,map:o,center:e,radius:t}},A=function(t,n){i=[];var s=z(t,n);g.setOptions(s),g.bindTo("center",p,"position");for(var r=g.getBounds(),c=0;c<a.length;c++)r.contains(new google.maps.LatLng(a[c].lat,a[c].lng))?(i.push(a[c]),l[c].setMap(o),o.fitBounds(r),e("#listKot").attr("value",JSON.stringify(i))):l[c].setMap(null)},S=function(){e("#gmap").css({display:"none"}),e(".mapInfo").css({height:"auto",marginLeft:0,"float":"none"})},_=function(){e("#gmap").css({display:"block"}),e(".mapInfo").css({height:"auto",marginLeft:0,"float":"left"})},F=function(){var e=[{featureType:"administrative.country",elementType:"geometry.stroke",stylers:[{color:"#00006f"},{lightness:-5},{visibility:"on"},{weight:3},{hue:"#ff0091"}]},{featureType:"all",elementType:"all",stylers:[{invert_lightness:!0},{saturation:0},{lightness:25},{gamma:.6},{hue:"#435158"}]}],t={disableDefaultUI:!0,scrollwheel:!1,zoom:7,minZoom:7,maxZoom:17,mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(50.5,4.6),styles:e};o=new google.maps.Map(document.getElementById("gmap"),t)},G=function(e,t,a){g&&g.setMap(null),m=Number(a);var n=t,s=f.computeOffset(n,m,0),l=f.computeOffset(n,m,-90),r=f.computeOffset(n,m,180),i=f.computeOffset(n,m,90);if("ville"===e){p.setPosition(n),p.setMap(o);var c="#FF0000"}var c="#0000FF",m=google.maps.geometry.spherical.computeDistanceBetween(n,s),u=z(t,m,c);g.setOptions(u);for(var d=new Array(s,l,r,i),v=new google.maps.LatLngBounds,h=0,y=d.length;y>h;h++)v.extend(d[h]);o.fitBounds(v),A(t,m)},U=function(e,o,t){if(!(t>=o)){var a=google.maps.event.addListener(e,"zoom_changed",function(){google.maps.event.removeListener(a),U(e,o,t+1)});setTimeout(function(){e.setZoom(t)},80)}},V=function(t,a,n,s){var l=Number(a);if("geocoder"===n){D(L,1);{({disableDefaultUI:!0,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,center:u.geocode({address:t,region:"BE"},function(t,n){if(n===google.maps.GeocoderStatus.OK){var r=t[0].geometry.location;o.setZoom(10),o.panTo(r),e("#coords").attr("value",r);{f.computeOffset(r,l,360)}p.setPosition(r),p.setMap(o),google.maps.event.addListener(p,"click",function(){U(o,20,o.getZoom()),o.panTo(p.getPosition())}),G("ville",r,a),s(!0)}else n===google.maps.GeocoderStatus.ZERO_RESULTS?s(!1,"La google map n'a rien trouvé car aucune donnée n'a été entré"):n===google.maps.GeocoderStatus.INVALID_REQUEST&&s(!1,"La google map n'a rien trouvé car la requête est incorrect")})})}}else"latlng"===n&&(D(L,1),o.setZoom(13),o.panTo(t),p.setPosition(t),p.setMap(o),google.maps.event.addListener(p,"click",function(){U(o,20,o.getZoom()),o.panTo(p.getPosition())}),G("ville",t,a),s(!0))};google.maps.event.addDomListener(window,"load",M)}).call(this,jQuery);